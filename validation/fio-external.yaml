apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fio-external-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: zerofs-external
---
apiVersion: v1
kind: Pod
metadata:
  name: fio-external
  namespace: default
spec:
  restartPolicy: Never
  containers:
  - name: fio
    image: alpine:3.22.2
    command: ["sh", "-lc"]
    args:
    - |
      set -euo pipefail
      apk add --no-cache fio >/dev/null

      run() {
        name="$1"
        shift
        echo "=== ${name} ($(date -Is)) ==="
        fio --output-format=json --output=/tmp/${name}.json "$@"
        cat /tmp/${name}.json
        echo
      }

      # Prefill the file so later randread does not hit unwritten extents.
      run prefill_write_1m_endfsync \
        --name=prefill_write_1m_endfsync \
        --filename=/data/testfile \
        --size=512m \
        --rw=write \
        --bs=1m \
        --direct=1 \
        --iodepth=32 \
        --numjobs=1 \
        --end_fsync=1 \
        --group_reporting \
        --eta=never

      # Durable small writes (fsync after every write) to surface backend latency.
      run randwrite_4k_fsync1 \
        --name=randwrite_4k_fsync1 \
        --filename=/data/testfile \
        --size=512m \
        --rw=randwrite \
        --bs=4k \
        --direct=1 \
        --iodepth=1 \
        --numjobs=1 \
        --fsync=1 \
        --time_based \
        --runtime=45 \
        --group_reporting \
        --eta=never

      # Throughput-oriented random writes (no fsync) for a contrast point.
      run randwrite_4k_iodepth32 \
        --name=randwrite_4k_iodepth32 \
        --filename=/data/testfile \
        --size=512m \
        --rw=randwrite \
        --bs=4k \
        --direct=1 \
        --iodepth=32 \
        --numjobs=4 \
        --time_based \
        --runtime=45 \
        --group_reporting \
        --eta=never

      # Random reads (direct) to measure read path performance.
      run randread_4k_iodepth32 \
        --name=randread_4k_iodepth32 \
        --filename=/data/testfile \
        --size=512m \
        --rw=randread \
        --bs=4k \
        --direct=1 \
        --iodepth=32 \
        --numjobs=4 \
        --time_based \
        --runtime=45 \
        --group_reporting \
        --eta=never
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: fio-external-pvc
